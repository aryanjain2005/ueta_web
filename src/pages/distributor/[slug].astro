---
import ContactButton from "@components/contact-button";
import DdInfo from "@components/dd-info.astro";
import ProdList from "@components/prod-list";
import ScrollView from "@components/ui/scroll-view.astro";
import Layout from "@layouts/Layout.astro";

import { drizzle } from "drizzle-orm/d1";
import * as s from "db/schema";
import { getDistributor } from "db/server";

// Get user from middleware-injected locals
// @ts-ignore
const user = Astro.locals.user;

// Protect route: only distributor or admin allowed
const isAllowed =
  user && (user.role === "distributor" || user.type === "admin");

if (!isAllowed) {
  // Redirect to home page
  return Astro.redirect("/", 302);
}

// @ts-ignore
const { env } = Astro.locals.runtime;
console.log(env.DB);
const db = drizzle(env.DB, {
  schema: s,
});
const getDealerBySlug = async (slug: string) => {
  try {
    const entry = await getDistributor(db, slug);
    return entry;
  } catch (e) {
    console.log(e);
    return null;
  }
};
const { slug } = Astro.params;
if (!slug) return Astro.redirect("/404");
const entry = await getDealerBySlug(slug);
if (!entry) return Astro.redirect("/404");
---

<Layout title={entry.name} bread={["distributor", entry.name]}>
  <section class="px-2 sm:px-4 md:px-8 py-6">
    <div
      class="flex flex-col md:flex-row gap-4 sm:gap-8 md:gap-12 lg:gap-16 items-center md:items-start">
      <!-- LEFT: photo -->
      <div class="flex justify-center md:justify-start">
        <img
          src={entry.image || "/imgg.png"}
          alt={entry.name}
          class="w-40 h-40
            sm:w-44 sm:h-44
            md:w-48 md:h-48
            lg:w-52 lg:h-52
            rounded-md object-cover"
        />
      </div>

      <!-- RIGHT: details + contacts + map -->
      <div
        class="flex flex-col justify-between
          items-center md:items-start
          gap-2 sm:gap-3
          text-sm sm:text-base
          w-full md:w-auto max-w-md">
        <div>
          <p
            class="font-semibold text-base sm:text-lg md:text-2xl lg:text-4xl md:pb-3 pb-1 text-center md:text-left">
            {entry.name}
          </p>

          <p
            class="text-sm sm:text-base md:text-xl lg:text-2xl text-center md:text-left">
            {entry.shopName}
          </p>

          {
            entry.address && (
              <p class="leading-snug text-xs sm:text-sm md:text-base text-center md:text-left">
                {entry.address}
              </p>
            )
          }
        </div>

        {
          entry.contact.length > 0 && (
            <div class="flex flex-wrap items-center gap-2 pt-1 sm:text-sm md:text-lg lg:text-xl">
              <div class="flex flex-row flex-wrap gap-2">
                {entry.contact.map((contact) => (
                  <ContactButton size="normal" contact={contact} />
                ))}
              </div>

              {entry.location && (
                <a
                  href={entry.location}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-1 text-xs sm:text-sm md:text-base text-black hover:underline">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-5 h-5 md:w-6 md:h-6">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"
                    />
                  </svg>
                </a>
              )}
            </div>
          )
        }
      </div>
    </div>
  </section>

  {
    entry.shopImages && entry.shopImages.length > 0 && (
      <ScrollView class="mx-auto">
        {entry.shopImages.map((image) => (
          <div class="h-[100px] sm:h-[160px] min-w-fit">
            <img src={image} class="rounded-md h-full" loading="lazy" />
          </div>
        ))}
      </ScrollView>
    )
  }

  <ProdList client:load brands={entry.brands} />
</Layout>
