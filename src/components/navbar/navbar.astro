---
import { Astronav, MenuItems, MenuIcon } from "astro-navbar";
import SearchBar from "@components/SearchBar";

// The middleware should set locals.user when JWT is valid:
// e.g. context.locals.user = payload
const user = Astro.locals?.user ?? null;

// TOKEN constant usage is in middleware/login/logout; Navbar only reads locals
// Use server-side form POST to logout to ensure cookie is cleared server-side
const logoutAction = "/api/auth/logout";
---

<header
  class="flex flex-col md:flex-row justify-between items-center py-5 px-8 w-full bg-[#0046BE] text-white">
  <Astronav>
    <div class="flex w-full lg:w-auto items-center justify-between">
      <div class="flex items-center justify-between">
        <a href="/" class="text-lg"><span class="font-bold">UETA</span></a>

        <div class="ml-4 hidden lg:flex items-center pr-2 gap-2">
          <SearchBar client:load />
        </div>
      </div>

      <div class="block lg:hidden">
        <MenuIcon class="w-4 h-4 text-white" />
      </div>
    </div>

    <MenuItems class="hidden w-full lg:w-auto mt-2 lg:flex lg:mt-0">
      <div
        class="w-fit flex lg:hidden items-center pr-2 gap-2 bg-white rounded-md">
        <input
          type="text"
          placeholder="Search"
          class="py-1 pl-2 rounded-md text-black focus:outline-none"
        />
        <button>
          <svg
            width="19"
            height="19"
            viewBox="0 0 19 19"
            fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M2.02359 7.12516C2.02359 6.01264 2.35349 4.9251 2.97158 4.00007C3.58966 3.07505 4.46817 2.35408 5.496 1.92833C6.52383 1.50259 7.65483 1.3912 8.74598 1.60824C9.83712 1.82528 10.8394 2.36101 11.6261 3.14768C12.4127 3.93435 12.9485 4.93663 13.1655 6.02777C13.3826 7.11892 13.2712 8.24992 12.8454 9.27775C12.4197 10.3056 11.6987 11.1841 10.7737 11.8022C9.84865 12.4203 8.76111 12.7502 7.64859 12.7502C6.15675 12.7502 4.72601 12.1575 3.67112 11.1026C2.61623 10.0477 2.02359 8.617 2.02359 7.12516ZM18.3136 16.7927L13.2736 11.7152C14.4353 10.2881 15.0046 8.4693 14.8637 6.63454C14.7229 4.79978 13.8828 3.08919 12.5168 1.85612C11.1509 0.623053 9.36358 -0.0382946 7.52402 0.00869008C5.68447 0.0556747 3.93322 0.807402 2.63203 2.10859C1.33084 3.40978 0.579112 5.16103 0.532128 7.00059C0.485143 8.84015 1.14649 10.6275 2.37956 11.9934C3.61263 13.3593 5.32322 14.1995 7.15798 14.3403C8.99274 14.4811 10.8115 13.9119 12.2386 12.7502L17.3161 17.8277C17.3817 17.8942 17.46 17.9471 17.5462 17.9831C17.6325 18.0192 17.7251 18.0377 17.8186 18.0377C17.9111 18.0384 18.0028 18.0202 18.0879 17.9841C18.1731 17.9479 18.2499 17.8947 18.3136 17.8277C18.3849 17.7617 18.4419 17.6816 18.4808 17.5926C18.5197 17.5035 18.5398 17.4074 18.5398 17.3102C18.5398 17.213 18.5197 17.1168 18.4808 17.0278C18.4419 16.9387 18.3849 16.8587 18.3136 16.7927Z"
              fill="black"></path>
          </svg>
        </button>
      </div>

      <div class="lg:hidden flex items-center mt-3 gap-4">
        <!-- If client-side auth controls needed, keep this; otherwise server renders below -->
        <div class="flex items-center gap-3">
          {
            user ? (
              <>
                {user.img && (
                  <img
                    src={user.img}
                    alt="avatar"
                    class="w-8 h-8 rounded-full"
                  />
                )}
                <div class="flex flex-col">
                  <span class="text-black font-semibold">{user.name}</span>
                  {/* <span class="text-sm text-gray-600">{user.role}</span> */}
                </div>
                <form method="post" action={logoutAction}>
                  <button
                    type="submit"
                    class="ml-3 px-3 py-1 bg-white text-blue-700 rounded">
                    Logoutttttt
                  </button>
                </form>
              </>
            ) : (
              <>
                <a
                  href="/login"
                  class="px-3 py-1 bg-white text-blue-700 rounded">
                  Login
                </a>
                <a
                  href="/signup"
                  class="px-3 py-1 bg-white text-blue-700 rounded">
                  Sign Up
                </a>
              </>
            )
          }
        </div>
      </div>
    </MenuItems>
  </Astronav>

  <div class="hidden lg:flex items-center gap-4">
    <!-- Desktop auth area (server-side rendered using Astro.locals.user) -->
    {
      user ? (
        <div class="flex items-center gap-3">
          {user.img && (
            <img src={user.img} alt="avatar" class="w-10 h-10 rounded-full" />
          )}
          <div class="flex flex-col">
            <span class="font-semibold">{user.name}</span>
            {/* <span class="text-sm">{user.role}</span> */}
          </div>
          <form method="post" action={logoutAction}>
            <button
              type="submit"
              class="ml-4 px-4 py-2 bg-white text-[#0046BE] rounded">
              Logouttttt
            </button>
          </form>
        </div>
      ) : (
        <div class="flex items-center gap-3">
          <a href="/login" class="px-4 py-2 bg-white text-[#0046BE] rounded">
            Login
          </a>
          <a href="/signup" class="px-4 py-2 bg-white text-[#0046BE] rounded">
            Sign Up
          </a>
        </div>
      )
    }
  </div>
</header>
